데이터셋이 매우 크거나 질의 처리량이 매우 높다면 복제만으로는 부족하고 데이터를 파티션으로 쪼갤 필요가 있다 이 작업을 샤딩이라고 한다

데이터 파티셔닝을 원하는 주된 이유는 확장성

여러 디스트에 부산될 수 있고 질의 부하는 여러 프로세서에 분산될 수 있다.

## 파티셔닝 복제

복제와 파티셔닝을 함께 적용해 각 파티션의 복사본을 여러 노드에 저장

파티션별로 리더와 팔로워가 될 수 있다.

## 키값 데이터 파티셔닝

### 키 범위 기준 파티셔닝

각 파티션에 연속된 범위의 키를 할당

키의 범위가 동일할 필요가 없다.

1번 파티션 (A~B), 5번 파팃션 (T~Z)

데이터를 고르게 분산시키려면 데이터에 맞춰 조정해야한다

키의 범위는 특정한 접근 패턴이 핫스팟을 유발한다는 단점

쏠림(skewed) : 특정 파티션에 데이터가 많거나 질의를 많이 받음

핫스팟 : 불균형하게 부하가 높은 파티션 

### 키의 해시값 기준 파티셔닝

좋은 해시 함수는 쏠린 데이터를 입력으로 받아 균일하게 분산되게 한다

입력 문자열이 비슷해도 해시값은 숫자 범위 내에서 균일하게 분산된다

해시값을 사용하면서 키의 장점인 범위 질의 속성을 잃어버린다.

### 파티셔닝과 보조 색인

문서 기준 보조 색인 파티셔닝

파티션별로 자신의 보조 색인을 유지하며 담당, 다른 파티션에 어떤 데이터가 저장되는지 신경쓰지 않는다.

지역 색인이라고 불린다.

파티셔닝된 데이터베이스에 질의를 보내는 방법을 스캐터(scatter)/개터(gather)

보조 색인을 사용해서 읽는 질의는 여러 파티셔닝에 대해 질의를 해야함으로 큰 비용이 들 수 있다.

### 용어 기준 보조 색인 파티셔닝

각 파티션이 자신만의 보조 색인을 갖게 하는 대신 모든 파티션의 데이터를 담당하는 전역 색인을 만들 수 있다.

한 노드에만 색인을 저장하게 되면 병목현상이 발생함으로 파티셔닝처리로 저장하게 된다.

전역 색인은 쓰기가 느리고 복잡하다는 단점

## 파티션 재균형화

한 노드가 담당하던 부하를 다른 노드로 옮기는 과정을 재균형화라고 한다.

### 파티션 개수 고정

파티션을 노드 대수보다 많이 만들고 각 노드에 여러 파티션을 할당하는 것

### 동적 파티셔닝

파티션 크기가 설정된 값을 넘어서면 파티션을 두 개로 쪼개 각각에 원래 파티션의 절반 정도의 데이터가 포함되게 한다. 반대로 임곗값 아래로 떨어지면 합쳐질 수 있다.

### 노드 비례 파티셔닝

노드당 파티션 개수를 고정한다.

노드 대수가 변함 없는 동안은 개별 파티션 크기가 데이터셋 크기에 비례해서 증가하지만 노드 대수를 늘리면 파티션 크기는 작아진다.

일반적으로 데이터 용량이 클수록 데이터를 저장할 노드도 많이 필요하므로 이 방법을 쓰면 개별 파티션 크기도 상당히 안정적으로 유지된다.

## 요청 라우팅

각 노드는 주키퍼에 자신을 등록하고 주키퍼는 파티션과 노드 사이의 신뢰성 잇는 할당 정보를 관리한다.

클라이언트는 주키퍼 정보를 구독하여 요청 정보를 노드에 할당한다.